(function(m,i,b,t,$,I,B,x,_){"use strict";var E=i.findByProps("canUseAnimatedEmojis"),L="canUseStickersEverywhere",R="canUseCustomStickersEverywhere",U=E[R]?R:L,M=()=>b.instead(U,E,()=>!0);function G(e,r,n,a,s,c,l){try{var o=e[c](l),d=o.value}catch(S){n(S);return}o.done?r(d):Promise.resolve(d).then(a,s)}function T(e){return function(){var r=this,n=arguments;return new Promise(function(a,s){var c=e.apply(r,n);function l(d){G(c,a,s,l,o,"next",d)}function o(d){G(c,a,s,l,o,"throw",d)}l(void 0)})}}var{getChannel:O}=i.findByStoreName("ChannelStore"),V="https://media.discordapp.net/stickers/{stickerId}.{format}?size={size}";function D(e,r){if(!e.guild_id)return!0;var n=O(r).guild_id;return e.guild_id==n}function H(e){var r=e.format_type===4?"gif":"png";return V.replace("{stickerId}",e.id).replace("{format}",r).replace("{size}",t.storage.stickerSize.toString())}function j(e){return p.apply(this,arguments)}function p(){return p=T(function*(e){try{var r=new FormData;r.append("new-image-url",e);var n=yield fetch("https://ezgif.com/apng-to-gif",{method:"POST",body:r}),a=n.url.split("/").pop().replace(/\.html$/,"");if(!a)throw new Error("Failed to retrieve GIF url.");r=new FormData,r.append("file",a),r.append("size",t.storage.stickerSize.toString());var s=yield fetch(`https://ezgif.com/apng-to-gif/${a}.html?ajax=true`,{method:"POST",body:r}),c=yield s.text(),l=c.split('<img src="')[1].split('" style=')[0];if(!l)throw new Error("Failed to retrieve GIF url.");return`https:${l}`}catch(o){return I.logger.error(`Failed to convert ${e} to GIF: `,o),null}}),p.apply(this,arguments)}var K=18e5,h=new Map;function q(e,r){h.set(e,r),setTimeout(()=>h.delete(e),K)}function J(e){return h.get(e)}var{openAlert:Q}=i.findByProps("openAlert","dismissAlert"),{AlertModal:C,AlertActionButton:y}=i.findByProps("AlertModal","AlertActions"),{Stack:W,TextInput:me}=i.findByProps("Stack");function F(e){C&&y?X(e):B.showConfirmationAlert(e)}function X({title:e,content:r,placeholder:n,confirmText:a,cancelText:s,onConfirm:c}){Q(Y(e),React.createElement(C,{title:e,content:r,actions:React.createElement(W,null,React.createElement(y,{text:a,variant:"primary",onPress:c}),s?React.createElement(y,{text:s,variant:"secondary"}):React.createElement(React.Fragment,null))}))}function Y(e){return`vdarnfg-${e?.toLowerCase?.().replaceAll?.(" ","-")}`}function Z(e){F({title:"APNG Sticker",content:`This sticker will be converted to a GIF using Ezgif and an Ezgif link will be sent in chat.
Do you want to continue?`,confirmText:"Continue",cancelText:"Cancel",onConfirm:e})}function ee(e){F({title:"APNG conversion failed",content:[(e?"Instead of an animated GIF, raw APNG sticker will be sent in chat":"No stickers will be sent in chat")+", you can customize this behavior in plugin settings.","","Check debug logs for more information about the error."].join(`
`),confirmText:"OK"})}var P=i.findByProps("sendMessage","receiveMessage"),{getStickerById:te}=i.findByStoreName("StickersStore"),{getCurrentUser:re}=i.findByStoreName("UserStore"),ae=()=>b.instead("sendStickers",P,(e,r)=>{if(!t.storage.ignoreNitro&&re?.().premiumType!==null)return r(...e);var[n,a,s,c]=e,l=a.map(u=>te(u)),o=l.filter(u=>!D(u,n));if(!o.length)return r(...e);var d=function(){var u=T(function*(fe=!1){fe&&(t.storage.ackedApng=!0);for(var v of o){var g=H(v);if(v.format_type===2&&t.storage.convertApng){var w=J(g);if(!w){$.showToast("Converting APNG sticker to GIF..");var A=yield j(g);if(A)q(g,A);else if(ee(t.storage.staticApngOnFail),!t.storage.staticApngOnFail)continue;w=A}g=w??g}t.storage.hyperlink&&v.name&&(g=`[${v.name}](${g})`),P.sendMessage(n,{content:g},null,c)}});return function(){return u.apply(this,arguments)}}(),S=o.find(u=>u.format_type==2)&&!t.storage.ackedApng;S?Z(()=>d(!0)):d()}),{Stack:ne,TableRadioGroup:oe,TableRadioRow:ie,TableSwitchRow:f,TableRowGroup:N}=i.findByProps("TableRow","TableRowGroup"),{ScrollView:se}=_.General,ce=i.findByName("HelpMessage"),le=[16,32,64,128,160,256,512,1024];t.storage.convertApng??=!0,t.storage.hyperlink??=!0,t.storage.stickerSize??=160;function de(){return x.useProxy(t.storage),React.createElement(se,{style:{flex:1},contentContainerStyle:{paddingBottom:38}},React.createElement(ne,{style:{paddingVertical:24,paddingHorizontal:12},spacing:24},React.createElement(N,{title:"General"},React.createElement(f,{label:"Hyperlink stickers",value:t.storage.hyperlink,onValueChange:e=>t.storage.hyperlink=e}),React.createElement(f,{label:"Ignore Nitro",subLabel:"Force FreeStickers even when you have Nitro",value:t.storage.ignoreNitro,onValueChange:e=>t.storage.ignoreNitro=e})),React.createElement(N,{title:"APNG Stickers"},React.createElement(f,{label:"Convert APNG stickers to GIF",subLabel:"This is needed for stickers to be animated (uses Ezgif).",value:t.storage.convertApng,onValueChange:e=>t.storage.convertApng=e}),React.createElement(f,{label:"Send static sticker if APNG conversion fails",value:t.storage.staticApngOnFail,onValueChange:e=>t.storage.staticApngOnFail=e}),React.createElement(f,{label:"Show warning dialog for APNG stickers",subLabel:"This will only appear once",value:!t.storage.ackedApng,onValueChange:e=>t.storage.ackedApng=!e})),React.createElement(oe,{title:"Stickers Size",value:t.storage.stickerSize.toString(),onChange:e=>t.storage.stickerSize=parseInt(e)},le.map(e=>React.createElement(ie,{label:e.toString(),subLabel:e==160?"Default":null,key:e.toString(),value:e.toString()}))),React.createElement(ce,{messageType:0},"Stickers size option does not work consistently at the moment.")))}var k,ge=()=>{k&&z(),k=[M(),ae()]},z=()=>k?.forEach?.(e=>e?.()),ue=de;return m.onLoad=ge,m.onUnload=z,m.settings=ue,m})({},vendetta.metro,vendetta.patcher,vendetta.plugin,vendetta.ui.toasts,vendetta,vendetta.ui.alerts,vendetta.storage,vendetta.ui.components);
